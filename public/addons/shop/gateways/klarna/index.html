<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Klarna - Perch CMS documentation</title>
  <meta name="description" content="Perch documentation">
  <meta property="og:title" content="Klarna">
  <meta property="og:description" content="Perch documentation">
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <link href="/assets/css/docs.css" rel="stylesheet">
  <script type="text/javascript" src="//use.typekit.net/kiw6gix.js"></script>
    <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
  

</head>
<body>
  <nav class="global-bar show-for-small-only">
    <ul class="nav-products">
        <li class="docs"><a href="https://docs.grabaperch.com">Docs</a></li>
    </ul>
    <a href="?nav=show" class="hamburger">☰</a>
</nav>
<nav class="global-bar primary show-for-medium">
    <ul class="nav-products">
        <li class="perch"><a href="https://grabaperch.com">Perch</a></li>
        <li class="runway"><a href="https://perchrunway.com">Runway</a></li>
        <li class="shop"><a href="https://shop.perchcms.com">Perch Shop</a></li>
        <li class="addons first-right"><a href="https://grabaperch.com/add-ons">Add-ons</a></li>
        <li class="selected docs"><a href="https://docs.grabaperch.com">Docs</a></li>
        <li class="support"><a href="https://community.perchcms.com/forum/">Support</a></li>
        <li class="account"><a href="https://account.perchcms.com">Account</a></li>
    </ul>
</nav>
<nav class="site-nav">
    <ul>
        <li class="home-link"><a href="/perch/">Perch Docs</a></li>
        <li><a href="/runway/">Runway Docs</a></li>
        <li><a href="/video/">Video</a></li>
        <li><a href="/templates/">Template Reference</a></li>
        <li><a href="/functions/">Function Reference</a></li>
        <li class="selected"><a href="/addons/">Add-ons</a></li>
        <li><a href="/api/">API</a></li>
    </ul>

    <div class="global-search" role="search">
      <div class="gcse-searchbox"></div>
    </div>

    <style>
      .custom-search {
        with
      }
  
      table.gsc-input {
        margin: 0;
        height: 1.5em;
      }

      form.gsc-search-box {
        margin: 0;
      }

      .gsc-search-box tbody {
        border: none;
      }

      .gsc-search-box tbody td {
        padding: 0;
      }

      .gsc-control-cse {
        padding: 0;
      }

      .gsc-input-box {
        border: none;
      }

      .gsc-search-box a {
        padding: 0;
      }
    </style>
</nav>

<div class="gcse-searchresults"></div>
<main class="wrapper">
    <nav class="sidebar">
    <ul class="sidenav">
                        <li>
                            <a href="/addons/announcements/">Announcements App</a>
                             
                             
                             
                        </li>
                        <li>
                            <a href="/addons/backup/">Backup App</a>
                             
                             
                        </li>
                        <li>
                            <a href="/addons/blog/">Blog App</a>
                             
                             
                             
                             
                             
                             
                             
                             
                             
                        </li>
                        <li>
                            <a href="/addons/comments/">Comments App</a>
                             
                             
                             
                             
                        </li>
                        <li>
                            <a href="/addons/email_octopus/">EmailOctopus App</a>
                             
                             
                        </li>
                        <li>
                            <a href="/addons/events/">Events App</a>
                             
                             
                             
                             
                             
                             
                             
                        </li>
                        <li>
                            <a href="/addons/feathers/">Feathers</a>
                        </li>
                        <li>
                            <a href="/addons/field-types/">Field Types</a>
                             
                        </li>
                        <li>
                            <a href="/addons/forms/">Forms App</a>
                             
                             
                             
                             
                        </li>
                        <li>
                            <a href="/addons/gallery/">Gallery App</a>
                             
                             
                             
                             
                        </li>
                        <li>
                            <a href="/addons/kraken/">Kraken App</a>
                             
                             
                             
                        </li>
                        <li>
                            <a href="/addons/listings/">Listings App</a>
                             
                             
                             
                        </li>
                        <li>
                            <a href="/addons/mailchimp/">Mailchimp App</a>
                             
                             
                             
                             
                        </li>
                        <li>
                            <a href="/addons/members/">Members App</a>
                             
                             
                             
                             
                        </li>
                        <li>
                            <a href="/addons/plugins/">Plugins</a>
                             
                             
                        </li>
                        <li>
                            <a href="/addons/podcasts/">Podcasts App</a>
                             
                             
                             
                        </li>
                        <li>
                            <a href="/addons/poll/">Poll App</a>
                             
                             
                             
                             
                        </li>
                        <li>
                            <a href="/addons/qr/">QRGenerator App</a>
                             
                             
                             
                        </li>
                        <li>
                            <a href="/addons/shop-foxycart/">Foxycart Shop App</a>
                             
                             
                             
                        </li>
                        <li>
                            <a href="/addons/shop-paypal/">PayPal Shop App</a>
                             
                             
                             
                        </li>
                        <li>
                            <a href="/addons/shop/">Shop App</a>
                            <ul>    <li>
                            <a href="/addons/shop/cart/">The Cart</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/changelog/">Changelog</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/checkout/">Checkout</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/customers/">Customers</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/examples/">Examples</a>
                             
                             
                             
                             
                             
                             
                             
                             
                             
                             
                             
                             
                             
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/gateways/">Payment Gateways</a>
                            <ul>    <li>
                            <a href="/addons/shop/gateways/braintree/">Braintree</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/gateways/klarna/" class="selected">Klarna</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/gateways/manual/">Manual</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/gateways/paypal-express/">PayPal Express</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/gateways/paypal/">PayPal</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/gateways/revolut/">Revolut</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/gateways/stripe-sca/">Stripe SCA</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/gateways/stripe/">Stripe</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/gateways/worldpay/">WorldPay</a>
                        </li>
                    </ul>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/installation/">Installation</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/orders/">Orders</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/products/">Products</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/requirements/">Requirements</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/shipping/">Shipping</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/tax/">Tax</a>
                             
                             
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/updating/">Updating</a>
                        </li>
                    </ul>
                        </li>
                        <li>
                            <a href="/addons/twillio/">Twilio App</a>
                             
                             
                             
                        </li>
                        <li>
                            <a href="/addons/twitter/">Twitter App</a>
                             
                             
                             
                             
                             
                             
                        </li>
    </ul>  </nav>

<article class="content">


  <h1>Klarna</h1>

  <p><em>Gateway slug:</em> <code>klarna</code></p>
<p>These are instructions for Klarna payments.</p>
<h2 id="settings">Settings</h2>
<p>Klarna is available to the following countries:</p>
<pre><code>Australia, Austria,Belgium, Canada,Czech Republic,Denmark&quot;,Finland,France,Germany,Greece,Hungary,Ireland (Republic of Ireland)
,Italy,Mexico,Netherlands,New Zealand,Norway,Poland,Portugal,Romania,Slovakia,Spain, Sweden,  Switzerland,United Kingdom, United States
</code></pre><p>In your <code>perch/config/shop.php</code> file, add your settings for Klarna.</p>
<pre><code class="lang-php">&lt;?php
  return [
    &#39;gateways&#39; =&gt; [
      &#39;klarna&#39; =&gt; [
        &#39;enabled&#39;   =&gt; true,
        &#39;test_mode&#39; =&gt; true,
        &#39;live&#39; =&gt; [
            &#39;secret_key&#39;      =&gt; &#39;klarna_api_secret&#39;,
             &#39;publishable_key&#39; =&gt; &#39;klarna_api_key&#39;,
             &#39;merchantId&#39; =&gt;  &#39;klarna_api_merchant_id&#39;,

        ],
        &#39;test&#39; =&gt; [

            &#39;secret_key&#39;      =&gt; &#39;klarna_api_secret&#39;,
             &#39;publishable_key&#39; =&gt; &#39;klarna_api_key&#39;,
             &#39;merchantId&#39; =&gt;  &#39;klarna_api_merchant_id&#39;,

        ],
      ],
    ],
  ];
?&gt;
</code></pre>
<h2 id="getting-your-klarna-test-credentials">Getting your Klarna test credentials</h2>
<p>To start testing with klarna, you need to create an account in the Klarna Playground, and then get API credentials for that account. These go into your Shop config file.</p>
<p>Once you’ve registered your Klarna Merchant Account, you can get test credentials by following these steps:</p>
<p>1.Log in to your Klarna Merchant Portal.</p>
<p>2.Navigate to the API or Integration section (it may be called “Developers” or similar).</p>
<p>3.You will see a section for API credentials where you can find your test credentials.
Typically, these test credentials consist of:</p>
<p>-API Key  – A unique key used to authenticate API requests.
-Secret Key – The secret key used to sign API requests.
-Merchant ID – A unique ID for your Klarna Merchant account.</p>
<p>Copy that api key , Secret and Merchant ID into the <code>test</code> section of the Shop config file.</p>
<p>When you’re <a href="https://developer.paypal.com/docs/classic/lifecycle/goingLive/">ready to go live</a>, your client can log into the Klarna account money is to be paid into and obtain a set of <a href="https://www.paypal.com/us/cgi-bin/webscr?cmd=_profile-api-signature">live credentials</a> directly from PayPal.</p>
<h2 id="payment-flow">Payment flow</h2>
<p>The process for Klarna goes like this:</p>
<ol>
<li>You call <code>perch_shop_checkout()</code> and the user gets sent to Klarna to make the payment</li>
<li>The user gets sent back to a page on your site with a <code>klarna_order_id</code> in the URL</li>
<li>You need to then call <code>perch_shop_klarna_confirm_payment()</code> to take that klarna_order_id and complete the payment (the user says on your page)</li>
</ol>
<h3 id="step-1-initiating-checkout">Step 1: Initiating checkout</h3>
<pre><code class="lang-php">&lt;?php
if (perch_member_logged_in()) {


 //URL for the terms and conditions page of the merchant. 
 //The URL will be displayed inside the Klarna Checkout iFrame.
 $terms_url = &#39;https://yourstore.com/terms&#39;;

 //URL for the checkout page of the merchant.
 $checkout_url = &#39;https://yourstore.com/checkout&#39;;

 //URL of the merchant confirmation page. klarna_order_id placeholder is mandatory!
 $confirmation_url = &#39;https://yourstore.com/payment?klarna_order_id={checkout.order.id}&#39;;

  perch_shop_checkout(&#39;klarna&#39;, [
    &#39;terms_url&#39; =&gt; $terms_url,
    &#39;checkout_url&#39; =&gt; $checkout_url,
    &#39;confirmation_url&#39;=&gt; $confirmation_url,
  ]);
}
?&gt;
</code></pre>
<h3 id="step-2-the-user-goes-off-to-klarna">Step 2: The user goes off to Klarna</h3>
<p>If the payment is authorised at Klarna, the user will be returned to the <code>confirmation_url</code> - your ‘payment’ page.</p>
<h3 id="step-3-confirm-payment">Step 3: Confirm payment</h3>
<p>The user will be redirected back to the <code>confirmation_url</code> page if the authorization is successful after the customer clicks on the ‘Place Order’ button inside checkout.
 Perch Shop will pick up the order id automatically - all you need to do is call <code>perch_shop_klarna_confirm_payment()</code> .</p>
<pre><code class="lang-php">&lt;?php

 $success_url= &#39;/payment/success&#39;;
 $cancel_url = &#39;/payment/went/wrong&#39;;

perch_shop_klarna_confirm_payment([
   &#39;success_url&#39; =&gt; $success_url,
      &#39;cancel_url&#39;=&gt; $cancel_url   ]);
?&gt;
</code></pre>
<h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="failed-payments">Failed payments</h3>
<p>While getting your shop set up, it’s likely you might see some issues processing payments until everything is configured just right. 
Shop outputs any payment gateway errors into its debug console. Turning on debug mode will enable you to see this output.</p>
<p>One issue you may need to combat is the payment process redirecting the browser before you can see the debug console. To solve that, we have instruct Perch to hold any redirects.</p>
<ol>
<li><a href="/docs/installing-perch/configuration/debug/">Enabled debug</a> for your page.</li>
<li>Before your call to <code>perch_shop_checkout()</code> add: <code>PerchUtil::hold_redirects();</code></li>
</ol>
<p>You should then be able to see any error messages. 
They may be verbose! Often the part of the message that is most useful is in red near the end.</p>
<p>Also on merchant portal Developer logs capture each step.</p>

</article>




</main>
<footer>
</footer>
<script async src="https://cse.google.com/cse.js?cx=007560778035763025039:043iekruiov"></script>
<script src="/assets/js/prism.js" async defer></script>
<script>
    if ("classList" in document.createElement("_")) {
        var hb = document.querySelectorAll('.hamburger');
        if (hb.length) {
            hb[0].addEventListener('click', function(e) {
                e.preventDefault();
                var nav = document.querySelectorAll('nav.primary')[0];
                if (!nav.classList.contains('show')) {
                    nav.classList.remove('show-for-medium', 'hide');
                    nav.classList.add('show');
                } else {
                    nav.classList.remove('show');
                    nav.classList.add('hide');
                }
            });
        }
    }


        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-8618320-3']);
        _gaq.push(['_trackPageview']);

        (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();

</script>
</body>
</html>
