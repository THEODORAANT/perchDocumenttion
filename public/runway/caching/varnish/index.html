<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Varnish - Perch CMS documentation</title>
  <meta name="description" content="Perch documentation">
  <meta property="og:title" content="Varnish">
  <meta property="og:description" content="Perch documentation">
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <link href="/assets/css/docs.css" rel="stylesheet">
  <script type="text/javascript" src="//use.typekit.net/kiw6gix.js"></script>
    <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
  

</head>
<body>
  <nav class="global-bar show-for-small-only">
    <ul class="nav-products">
        <li class="docs"><a href="https://docs.grabaperch.com">Docs</a></li>
    </ul>
    <a href="?nav=show" class="hamburger">☰</a>
</nav>
<nav class="global-bar primary show-for-medium">
    <ul class="nav-products">
        <li class="perch"><a href="https://grabaperch.com">Perch</a></li>
        <li class="runway"><a href="https://perchrunway.com">Runway</a></li>
        <li class="shop"><a href="https://shop.perchcms.com">Perch Shop</a></li>
        <li class="addons first-right"><a href="https://grabaperch.com/add-ons">Add-ons</a></li>
        <li class="selected docs"><a href="https://docs.grabaperch.com">Docs</a></li>
        <li class="support"><a href="https://community.perchcms.com/forum/">Support</a></li>
        <li class="account"><a href="https://account.perchcms.com">Account</a></li>
    </ul>
</nav>
<nav class="site-nav">
    <ul>
        <li class="home-link"><a href="/perch/">Perch Docs</a></li>
        <li class="selected"><a href="/runway/">Runway Docs</a></li>
        <li><a href="/video/">Video</a></li>
        <li><a href="/templates/">Template Reference</a></li>
        <li><a href="/functions/">Function Reference</a></li>
        <li><a href="/addons/">Add-ons</a></li>
        <li><a href="/api/">API</a></li>
    </ul>

    <div class="global-search" role="search">
      <div class="gcse-searchbox"></div>
    </div>

    <style>
      .custom-search {
        with
      }
  
      table.gsc-input {
        margin: 0;
        height: 1.5em;
      }

      form.gsc-search-box {
        margin: 0;
      }

      .gsc-search-box tbody {
        border: none;
      }

      .gsc-search-box tbody td {
        padding: 0;
      }

      .gsc-control-cse {
        padding: 0;
      }

      .gsc-input-box {
        border: none;
      }

      .gsc-search-box a {
        padding: 0;
      }
    </style>
</nav>

<div class="gcse-searchresults"></div>
<main class="wrapper">
    <nav class="sidebar">
    <ul class="sidenav">
                        <li>
                            <a href="/runway/caching/">Caching</a>
                            <ul>    <li>
                            <a href="/runway/caching/varnish/" class="selected">Varnish</a>
                        </li>
                    </ul>
                        </li>
                        <li>
                            <a href="/runway/cloud-storage/">Cloud Storage</a>
                             
                             
                             
                        </li>
                        <li>
                            <a href="/runway/collections/">Collections</a>
                             
                             
                             
                        </li>
                        <li>
                            <a href="/runway/configuration/">Configuration</a>
                        </li>
                        <li>
                            <a href="/runway/core-tasks/">Core Tasks</a>
                             
                             
                             
                        </li>
                        <li>
                            <a href="/runway/getting-started/">Getting Started with Runway</a>
                             
                             
                             
                             
                        </li>
                        <li>
                            <a href="/runway/headless/">Headless requests</a>
                             
                             
                        </li>
                        <li>
                            <a href="/runway/relationships/">Relationships</a>
                        </li>
                        <li>
                            <a href="/runway/routing/">Routing</a>
                             
                             
                             
                        </li>
                        <li>
                            <a href="/runway/site-access/">Controlling site access</a>
                        </li>
                        <li>
                            <a href="/runway/upgrading/">Upgrading to Runway 4</a>
                        </li>
                        <li>
                            <a href="/runway/upgrading3/">Upgrading to Runway 3</a>
                        </li>
    </ul>  </nav>

<article class="content">


  <h1>Varnish</h1>

  <p><a href="https://www.varnish-cache.org">Varnish</a> is a caching HTTP reverse proxy that you install infront of your website. perch Runway has the ability to tell your Varnish server when pages have changed so that they can be purged from the cache.</p>
<h2 id="configure">Configure</h2>
<p>Open up your <code>perch/config/runway.php</code> file and look for the Varnish section. It looks like this:</p>
<pre><code class="lang-html">&#39;varnish&#39; =&gt; [
    &#39;enabled&#39; =&gt; false,
],
</code></pre>
<p>Enable Varnish support by setting <code>enabled</code> to <code>true</code>.</p>
<h2 id="configuring-your-varnish-vcl">Configuring your Varnish VCL</h2>
<p>When a page is published, Runway will make an HTTP PURGE or BAN request to your Varnish server. You need to add rules to your VCL to respond to those requests.</p>
<p>The <code>PURGE</code> requests look like this:</p>
<pre><code>http://example.com/about-us
</code></pre><p>and the <code>BAN</code> requests contain a pattern, like this:</p>
<pre><code>http://example.com/products/([a-z0-9\-]+)/?$
</code></pre><p>You’ll want to configure your Varnish server to only accept the PURGE and BAN requests from trusted sources. This is done by setting up an ACL.</p>
<p>Your VCL might look something like this:</p>
<pre><code class="lang-html">acl purge {
    &quot;localhost&quot;;
    &quot;192.168.55.0&quot;/24;
}

sub vcl_backend_response {
    set beresp.http.x-url = bereq.url;
}

sub vcl_deliver {
    unset resp.http.x-url; # Optional
}

sub vcl_recv {
    # allow PURGE and BAN from localhost and 192.168.55...

    if (req.method == &quot;PURGE&quot;) {
        if (!client.ip ~ purge) {
                return(synth(405,&quot;Not allowed.&quot;));
        }
        return (purge);
    }

    if (req.method == &quot;BAN&quot;) {
        if (!client.ip ~ purge) {
                return(synth(405,&quot;Not allowed.&quot;));
        }
        ban(&quot;obj.http.x-url ~ &quot; + req.url); # req.url is a regex
        return(synth(200, &quot;Ban added&quot;));
    }
}
</code></pre>
<p>Note: we’re not 100% sure this is the optimal configuration. If you find problems or have improvements to suggest, we’d love to hear from you and make this documentation better.</p>

</article>




</main>
<footer>
</footer>
<script async src="https://cse.google.com/cse.js?cx=007560778035763025039:043iekruiov"></script>
<script src="/assets/js/prism.js" async defer></script>
<script>
    if ("classList" in document.createElement("_")) {
        var hb = document.querySelectorAll('.hamburger');
        if (hb.length) {
            hb[0].addEventListener('click', function(e) {
                e.preventDefault();
                var nav = document.querySelectorAll('nav.primary')[0];
                if (!nav.classList.contains('show')) {
                    nav.classList.remove('show-for-medium', 'hide');
                    nav.classList.add('show');
                } else {
                    nav.classList.remove('show');
                    nav.classList.add('hide');
                }
            });
        }
    }


        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-8618320-3']);
        _gaq.push(['_trackPageview']);

        (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();

</script>
</body>
</html>
