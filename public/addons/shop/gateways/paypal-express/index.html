<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PayPal Express - Perch CMS documentation</title>
  <meta name="description" content="Perch documentation">
  <meta property="og:title" content="PayPal Express">
  <meta property="og:description" content="Perch documentation">
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <link href="/assets/css/docs.css" rel="stylesheet">
  <script type="text/javascript" src="//use.typekit.net/kiw6gix.js"></script>
    <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
  

</head>
<body>
  <nav class="global-bar show-for-small-only">
    <ul class="nav-products">
        <li class="docs"><a href="https://docs.grabaperch.com">Docs</a></li>
    </ul>
    <a href="?nav=show" class="hamburger">☰</a>
</nav>
<nav class="global-bar primary show-for-medium">
    <ul class="nav-products">
        <li class="perch"><a href="https://grabaperch.com">Perch</a></li>
        <li class="runway"><a href="https://perchrunway.com">Runway</a></li>
        <li class="shop"><a href="https://shop.perchcms.com">Perch Shop</a></li>
        <li class="addons first-right"><a href="https://grabaperch.com/add-ons">Add-ons</a></li>
        <li class="selected docs"><a href="https://docs.grabaperch.com">Docs</a></li>
        <li class="support"><a href="https://community.perchcms.com/forum/">Support</a></li>
        <li class="account"><a href="https://account.perchcms.com">Account</a></li>
    </ul>
</nav>
<nav class="site-nav">
    <ul>
        <li class="home-link"><a href="/perch/">Perch Docs</a></li>
        <li><a href="/runway/">Runway Docs</a></li>
        <li><a href="/video/">Video</a></li>
        <li><a href="/templates/">Template Reference</a></li>
        <li><a href="/functions/">Function Reference</a></li>
        <li class="selected"><a href="/addons/">Add-ons</a></li>
        <li><a href="/api/">API</a></li>
    </ul>

    <div class="global-search" role="search">
      <div class="gcse-searchbox"></div>
    </div>

    <style>
      .custom-search {
        with
      }
  
      table.gsc-input {
        margin: 0;
        height: 1.5em;
      }

      form.gsc-search-box {
        margin: 0;
      }

      .gsc-search-box tbody {
        border: none;
      }

      .gsc-search-box tbody td {
        padding: 0;
      }

      .gsc-control-cse {
        padding: 0;
      }

      .gsc-input-box {
        border: none;
      }

      .gsc-search-box a {
        padding: 0;
      }
    </style>
</nav>

<div class="gcse-searchresults"></div>
<main class="wrapper">
    <nav class="sidebar">
    <ul class="sidenav">
                        <li>
                            <a href="/addons/announcements/">Announcements App</a>
                             
                             
                             
                        </li>
                        <li>
                            <a href="/addons/backup/">Backup App</a>
                             
                             
                        </li>
                        <li>
                            <a href="/addons/blog/">Blog App</a>
                             
                             
                             
                             
                             
                             
                             
                             
                             
                        </li>
                        <li>
                            <a href="/addons/comments/">Comments App</a>
                             
                             
                             
                             
                        </li>
                        <li>
                            <a href="/addons/email_octopus/">EmailOctopus App</a>
                             
                             
                        </li>
                        <li>
                            <a href="/addons/events/">Events App</a>
                             
                             
                             
                             
                             
                             
                             
                        </li>
                        <li>
                            <a href="/addons/feathers/">Feathers</a>
                        </li>
                        <li>
                            <a href="/addons/field-types/">Field Types</a>
                             
                        </li>
                        <li>
                            <a href="/addons/forms/">Forms App</a>
                             
                             
                             
                             
                        </li>
                        <li>
                            <a href="/addons/gallery/">Gallery App</a>
                             
                             
                             
                             
                        </li>
                        <li>
                            <a href="/addons/kraken/">Kraken App</a>
                             
                             
                             
                        </li>
                        <li>
                            <a href="/addons/listings/">Listings App</a>
                             
                             
                             
                        </li>
                        <li>
                            <a href="/addons/mailchimp/">Mailchimp App</a>
                             
                             
                             
                             
                        </li>
                        <li>
                            <a href="/addons/members/">Members App</a>
                             
                             
                             
                             
                        </li>
                        <li>
                            <a href="/addons/plugins/">Plugins</a>
                             
                             
                        </li>
                        <li>
                            <a href="/addons/podcasts/">Podcasts App</a>
                             
                             
                             
                        </li>
                        <li>
                            <a href="/addons/poll/">Poll App</a>
                             
                             
                             
                             
                        </li>
                        <li>
                            <a href="/addons/qr/">QRGenerator App</a>
                             
                             
                             
                        </li>
                        <li>
                            <a href="/addons/shop-foxycart/">Foxycart Shop App</a>
                             
                             
                             
                        </li>
                        <li>
                            <a href="/addons/shop-paypal/">PayPal Shop App</a>
                             
                             
                             
                        </li>
                        <li>
                            <a href="/addons/shop/">Shop App</a>
                            <ul>    <li>
                            <a href="/addons/shop/cart/">The Cart</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/changelog/">Changelog</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/checkout/">Checkout</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/customers/">Customers</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/examples/">Examples</a>
                             
                             
                             
                             
                             
                             
                             
                             
                             
                             
                             
                             
                             
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/gateways/">Payment Gateways</a>
                            <ul>    <li>
                            <a href="/addons/shop/gateways/braintree/">Braintree</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/gateways/klarna/">Klarna</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/gateways/manual/">Manual</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/gateways/paypal-express/" class="selected">PayPal Express</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/gateways/paypal/">PayPal</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/gateways/revolut/">Revolut</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/gateways/stripe-sca/">Stripe SCA</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/gateways/stripe/">Stripe</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/gateways/worldpay/">WorldPay</a>
                        </li>
                    </ul>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/installation/">Installation</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/orders/">Orders</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/products/">Products</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/requirements/">Requirements</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/shipping/">Shipping</a>
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/tax/">Tax</a>
                             
                             
                        </li>
                    </ul>
                            <ul>    <li>
                            <a href="/addons/shop/updating/">Updating</a>
                        </li>
                    </ul>
                        </li>
                        <li>
                            <a href="/addons/twillio/">Twilio App</a>
                             
                             
                             
                        </li>
                        <li>
                            <a href="/addons/twitter/">Twitter App</a>
                             
                             
                             
                             
                             
                             
                        </li>
    </ul>  </nav>

<article class="content">


  <h1>PayPal Express</h1>

  <p><em>Gateway slug:</em> <code>paypal-express</code></p>
<p>These are instructions for PayPal Express payments.</p>
<h2 id="settings">Settings</h2>
<p>In your <code>perch/config/shop.php</code> file, add your settings for PayPal Express.</p>
<pre><code class="lang-php">&lt;?php
  return [
    &#39;gateways&#39; =&gt; [
      &#39;paypal-express&#39; =&gt; [
        &#39;enabled&#39;   =&gt; true,
        &#39;test_mode&#39; =&gt; true,
        &#39;live&#39; =&gt; [
          &#39;username&#39;  =&gt; &#39;paypal_api_username&#39;,
          &#39;password&#39;  =&gt; &#39;paypal_api_password&#39;,
          &#39;signature&#39; =&gt; &#39;paypal_api_signature&#39;,
        ],
        &#39;test&#39; =&gt; [
          &#39;username&#39;  =&gt; &#39;paypal_api_username&#39;,
          &#39;password&#39;  =&gt; &#39;paypal_api_password&#39;,
          &#39;signature&#39; =&gt; &#39;paypal_api_signature&#39;,
        ],
      ],
    ],
  ];
?&gt;
</code></pre>
<p><strong>Note:</strong> these are <em>not</em> your regular PayPal account details - see below.</p>
<h2 id="getting-your-paypal-test-credentials">Getting your PayPal test credentials</h2>
<p>To start testing with PayPal, you need to create an account in the PayPal Sandbox, and then get API credentials for that account. These go into your Shop config file.</p>
<ol>
<li>Go to <a href="https://developer.paypal.com/">https://developer.paypal.com/</a></li>
<li>Log in using your regular PayPal account</li>
<li>Go to Dashboard</li>
<li>Under Sandbox to go Accounts</li>
<li>Either create a new Merchant (seller) Business account, or select one from the list</li>
<li>To to Profile and then API Credentials</li>
<li>Your Username, Password and Signature are displayed</li>
</ol>
<p>Copy that username, password and signature into the <code>test</code> section of the Shop config file.</p>
<p>When you’re <a href="https://developer.paypal.com/docs/classic/lifecycle/goingLive/">ready to go live</a>, your client can log into the PayPal account money is to be paid into and obtain a set of <a href="https://www.paypal.com/us/cgi-bin/webscr?cmd=_profile-api-signature">live credentials</a> directly from PayPal.</p>
<h2 id="payment-flow">Payment flow</h2>
<p>The process for PayPal Express goes like this:</p>
<ol>
<li>You call <code>perch_shop_checkout()</code> and the user gets sent to PayPal to make the payment</li>
<li>The user gets sent back to a page on your site with a <code>token</code> in the URL</li>
<li>You need to then call <code>perch_shop_complete_payment()</code> to take that token and complete the payment (the user says on your page)</li>
</ol>
<h3 id="step-1-initiating-checkout">Step 1: Initiating checkout</h3>
<pre><code class="lang-php">&lt;?php
if (perch_member_logged_in()) {

  // your &#39;success&#39; return URL
  $return_url = &#39;http://mysite.com/payment&#39;;
  $cancel_url = &#39;http://mysite.com/&#39;;

  perch_shop_checkout(&#39;paypal-express&#39;, [
    &#39;return_url&#39; =&gt; $return_url,
    &#39;cancel_url&#39; =&gt; $cancel_url,
  ]);
}
?&gt;
</code></pre>
<h3 id="step-2-the-user-goes-off-to-paypal">Step 2: The user goes off to PayPal</h3>
<p>The user will be sent to PayPal. If they cancel, they’ll be sent to the <code>cancel_url</code> URL - you don’t really need to do anything.</p>
<p>If the payment is authorised at PayPal, the user will be returned to the <code>return_url</code> - your ‘payment’ page.</p>
<h3 id="step-3-confirm-payment">Step 3: Confirm payment</h3>
<p>The user gets sent back to your <code>return_url</code> page with a token in the URL. Perch Shop will pick up the token automatically - all you need to do is call <code>perch_shop_complete_payment()</code> and let it know that you’re using <code>paypal-express</code> as the gateway.</p>
<pre><code class="lang-php">&lt;?php
  perch_shop_complete_payment(&#39;paypal-express&#39;);

  if (perch_shop_order_successful()) {
      echo &#39;&lt;h1&gt;Thank you for your order!&lt;/h1&gt;&#39;;
    }else{
      echo &#39;&lt;h1&gt;Sorry!&lt;/h1&gt;&#39;;
    }
?&gt;
</code></pre>
<h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="failed-payments">Failed payments</h3>
<p>While getting your shop set up, it’s likely you might see some issues processing payments until everything is configured just right. Shop outputs any payment gateway errors into its debug console. Turning on debug mode will enable you to see this output.</p>
<p>One issue you may need to combat is the payment process redirecting the browser before you can see the debug console. To solve that, we have instruct Perch to hold any redirects.</p>
<ol>
<li><a href="/docs/installing-perch/configuration/debug/">Enabled debug</a> for your page.</li>
<li>Before your call to <code>perch_shop_checkout()</code> add: <code>PerchUtil::hold_redirects();</code></li>
</ol>
<p>You should then be able to see any error messages. They may be verbose! Often the part of the message that is most useful is in red near the end.</p>
<h3 id="-transaction-cannot-complete-">‘Transaction cannot complete’</h3>
<p>It’s important that the seller’s PayPal account is configured for each currency you wish to sell in. This applies to sandbox (testing) accounts as much as live accounts. If your account is set to accept GBP and you put a transaction through in USD, it will fail with a message that looks like an insufficient funds error:</p>
<blockquote>
<p>10417: Transaction cannot complete. Instruct the customer to retry the transaction using an alternative payment method from the customers PayPal wallet. The transaction did not complete with the customers selected payment method.</p>
</blockquote>
<p>Don’t be fooled; this problem is nothing to do with the <em>buyer</em> and everything to do with the <em>seller’s</em> account configuration. To fix this, log into the seller account (either live, or via sandbox.paypal.com if testing) and add the currency you’re selling in:</p>
<ol>
<li>Go to My Account</li>
<li>In the Profile menu, select My Account Settings</li>
<li>Under Financial Information, select Currency Balances</li>
<li>Find the currency in the select list, and click Add Currency</li>
</ol>
<p>You should then be able to sell in that currency.</p>

</article>




</main>
<footer>
</footer>
<script async src="https://cse.google.com/cse.js?cx=007560778035763025039:043iekruiov"></script>
<script src="/assets/js/prism.js" async defer></script>
<script>
    if ("classList" in document.createElement("_")) {
        var hb = document.querySelectorAll('.hamburger');
        if (hb.length) {
            hb[0].addEventListener('click', function(e) {
                e.preventDefault();
                var nav = document.querySelectorAll('nav.primary')[0];
                if (!nav.classList.contains('show')) {
                    nav.classList.remove('show-for-medium', 'hide');
                    nav.classList.add('show');
                } else {
                    nav.classList.remove('show');
                    nav.classList.add('hide');
                }
            });
        }
    }


        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-8618320-3']);
        _gaq.push(['_trackPageview']);

        (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();

</script>
</body>
</html>
